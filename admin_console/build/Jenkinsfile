properties([
        parameters(
                [
                        stringParam(
                                name: 'CHART_NAME',
                                defaultValue: 'admin-console'
                        ),
                        stringParam(
                                name: 'IMAGE_TAG',
                                defaultValue: ''
                        ),
                        stringParam(
                                name: 'BUILD_PARAMS',
                                defaultValue: ''
                        ),
                        stringParam(
                                name: 'URL',
                                defaultValue: 'admin-console-postgresql'
                        ),
                        stringParam(
                                name: 'BRANCH',
                                defaultValue: 'develop'
                        )
                ]
        )
])

pipeline {

    options {
        ansiColor('xterm')
        skipDefaultCheckout true
    }

    agent {
        kubernetes {
            yamlFile 'admin_console/build/builder.yaml'
        }
    }

    stages {
        
        stage('Checkout') {
            steps {
                script {
                    if (IMAGE_TAG=="") {
                        error("Enter parameter value: IMAGE_TAG")
                        currentBuild.result = 'ABORTED'
                    }
                }
            }
        }

        stage('Clone git repos') {
            steps {
                container('git') {
                    script {
                        sh "git -C /kaniko/workspace/datagram_ci_cd stash"
                        sh "git -C /kaniko/workspace/datagram_ci_cd pull"
                        withCredentials([[
                           $class: 'UsernamePasswordMultiBinding',
                           credentialsId: 'rmusin',
                           usernameVariable: 'USERNAME',
                           passwordVariable: 'PASSWORD'
                        ]]) {
//                         sh "git -C /kaniko/workspace/datagram-admin-console stash"
//                         sh "git -C /kaniko/workspace/datagram-admin-console checkout ${params.BRANCH}"
//                         sh "git -C /kaniko/workspace/datagram-admin-console pull"
                        sh "rm -rf /kaniko/workspace/airflow-client"
                        sh "git clone https://$USERNAME:$PASSWORD@neogit.neoflex.ru/datagram/airflow-client.git /kaniko/workspace/airflow-client"
                        sh "rm -rf /kaniko/workspace/datagram-admin-console"
                        sh "git clone https://$USERNAME:$PASSWORD@neogit.neoflex.ru/datagram/datagram-admin-console.git /kaniko/workspace/datagram-admin-console -b ${params.BRANCH}"
                        sh "chmod +x /kaniko/workspace/datagram_ci_cd/admin_console/build/setUrl.sh"
                        sh "/kaniko/workspace/datagram_ci_cd/admin_console/build/setUrl.sh ${params.URL}"
                        }
                    }
                }
            }
        }

        stage('Build airflow-client Jar') {
            steps {
                container('maven') {
                    script {
                        sh "mvn clean install ${params.BUILD_PARAMS} -f /root/.m2/airflow-client/pom.xml"
                    }
                }
            }
        }
            
        stage('Build admin-console Jar') {
            steps {
                container('maven') {
                    script {
                        sh "mvn clean install ${params.BUILD_PARAMS} -f /root/.m2/datagram-admin-console/dg-admin-console-bk/pom.xml"
                    }
                }
            }
        }

        stage('Kaniko Build & Push Image') {
              steps {
                container('kaniko') {
                  script {
                    sh "/kaniko/executor --dockerfile /root/builder/datagram_ci_cd/admin_console/build/Dockerfile \
                                     --context /root/builder \
                                     --force \
                                     --destination=zanzibeer/${params.CHART_NAME}:${params.IMAGE_TAG}"
                  }
                }
              }
            }
//         stage ('build artifact') {
//             steps {
//                 container('docker') {
//                     script {
// //                         registryIp = sh(script: 'getent hosts registry.kube-system | awk \'{ print $1 ; exit }\'', returnStdout: true).trim()
//                         sh "docker build . -t ${registryIp}/datagram/app:${revision} --build-arg REVISION=${revision}"
//                     }
//                 }
//             }
//         }
//         stage ('publish artifact') {
//             when {
//                 expression {
//                     branch == 'master' || params.DEPLOY_BRANCH_TO_TST
//                 }
//             }
//             steps {
//                 container('docker') {
//                     sh "docker push ${registryIp}/demo/app:${revision}"
//                 }
//             }
//         }
//         stage ('deploy to env') {
//             when {
//                 expression {
//                     branch == 'master' || params.DEPLOY_BRANCH_TO_TST
//                 }
//             }
//             steps {
//                 build job: './../Deploy', parameters: [
//                         [$class: 'StringParameterValue', name: 'GIT_REPO', value: 'habr-demo-app'],
//                         [$class: 'StringParameterValue', name: 'VERSION', value: revision],
//                         [$class: 'StringParameterValue', name: 'ENV', value: branch == 'master' ? 'staging' : 'test']
//                 ], wait: false
//             }
//         }
    }
}
